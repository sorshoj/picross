<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

    <script>
        // variable declaration

        const square_length = 100;
        const margin = 100;
        const x = 3;
        const y = 3;
        let count_squares = 0;
        const Board = new Array(x*y);
        const player_board = new Array(x*y);
        const xclues = new Array();
        const yclues = new Array();

        class GameScene extends Phaser.Scene {
            constructor ()
            {
                super('GameScene');
            }

            preload ()
            {
                this.load.image('square', 'square.png');
                this.load.image('green', 'green_square.png');
                this.load.image('red', 'red.png');

                // game board generation - entirely random
                for (let i = 0; i < Board.length; i++){
                    let num = Math.floor(Math.random() * 2)
                    
                    Board[i] = num;
                    player_board[i] = num;
                    count_squares += num;
                }
                generate_xclues();
                generate_yclues();                 
            }

            create ()
            {

                let start_x = 0;
                let start_y = 0;
                let mod_val = (square_length*x);

                // turn images into interactive images, with data 0, 1 
                for (let i = 0; i < Board.length; i++) {
                    var tent = this.add.image(start_x+margin, start_y+margin, 'square').setOrigin(0,0).setInteractive();
                    

                    tent.setData('index', i);
                    tent.setData('found', 0);
                    tent.on('pointerdown', click);

                    start_x = (start_x + square_length) % mod_val;
                    if (start_x == 0){
                        start_y = start_y + square_length;
                    }
                }

                console.log("board: " + Board.toString());

                // add xclues to screen
                let ypos = margin + square_length/2;
                let xpos = margin / 3;
                for (let i = 0; i < xclues.length; i++) {
                    this.add.text(xpos, ypos, "" + xclues[i]);
                    ypos += square_length;
                }

                // add yclues to screen
                xpos = margin + square_length/2;
                ypos = margin / 3;
                for (let i = 0; i < yclues.length; i++) {
                    this.add.text(xpos, ypos, "" + yclues[i]);
                    xpos += square_length;
                }

                this.input.on('pointerup', function (pointer) {
                    if (count_squares <= 0) {
                        this.scene.pause();
                        this.scene.run('EndScene');
                    }
                }, this);

            }
        }

        function generate_yclues ()
        {
            let index = 0;
            let count = 0;
            let col = new Array();
            for (let i = 0; i < Board.length; i++) {
                if (Board[index] == 1) {
                    count += 1;
                } else {
                    if (count > 0) {
                        col.push(count);
                    }
                    count = 0;
                }

                index += x;
                if (index >= Board.length) {
                    // first push remaining count to col
                    if (count > 0 | col.length == 0) {
                        col.push(count);
                    }
                    yclues.push(col);
                    col = new Array();
                    count = 0;
                    index = index - Board.length + 1;
                }
            }
            console.log(yclues);
        }

        function generate_xclues () 
        {
            let count = 0;
            let row = new Array();
            for (let i = 0; i < Board.length; i++) {
                if (Board[i] == 1) {
                    count += 1;
                } else {
                    if (count > 0) {
                        row.push(count);
                    }
                    count = 0;
                }
                if (i % x == x-1){
                    if (count > 0) {
                        row.push(count);
                    } 
                    if (row.length == 0) {
                        row.push(0);
                    }
                    xclues.push(row);
                    row = new Array();
                    count = 0;
                }
            }
            console.log(xclues);
        }

        function click (pointer)
        {
            // TODO clicking twice on grey should remove the tint
            let index = this.getData('index');
            if (this.getData('found') == 0) {
                if (pointer.rightButtonDown()) {
                    // grey
                    this.setTint(0x828282);
                } else {
                    if (Board[index] == 0) {
                        // red
                        this.setTint(0xff0000);
                    } else {
                        // green
                        count_squares -= 1;
                        this.setTint(0x05fa46);
                    }
                   this.setData('found', 1);
                   player_board[index] = Math.abs(player_board[index]-1);
                }
            }
        }


        class EndScene extends Phaser.Scene {
            constructor ()
            {
                super('EndScene');
            }
            preload() 
            {
                this.load.image('endscene', 'endscene.png');                
            }

            create ()
            {
                this.add.image(100, 100, 'endscene').setOrigin(0,0).setAlpha(0.5);
            }
        }

        var config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'phaser-example',
            scene: [ GameScene, EndScene]
        };

        var game = new Phaser.Game(config);
                
    </script>

</body>
</html>