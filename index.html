<!DOCTYPE html>
<html>
<title>picross</title>

<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>
<body>

    <script src="./helper.js"></script>

    <script>
        document.addEventListener("contextmenu", function (e){ 
                e.preventDefault();
            }, false);

        class GameScene extends Phaser.Scene {
            constructor ()
            {
                super('GameScene');
                console.log('hit the constructor');

            }

            preload ()
            {
                // TODO move these loads to a different scene
                // these are reloaded every new game

                this.load.image('square', 'assets/square_v2.png');
                this.load.image('newgame', 'assets/newgame_v2.png');
                this.load.image('infobutton', 'assets/info_button_v2.png');
                console.log('hit the preload');

                // RESET VARIABLES FOR NEW GAME
                this.x = 10;
                this.y = 10;
                this.margin = 150;
                this.square_length = 50;
                let a = boardGeneration(this.x, this.y);
                this.xclues = a[0];
                this.yclues = a[1];
                this.Board = a[2];
                this.board_green = a[3];
                
                this.registry.set('lastSquare', -1);
                this.registry.set('board_green', 0);
                this.registry.set('player_red', 0);
                
                this.player_green = 0;
                this.player_board = new Array(this.x*this.y);

                this.graphics = this.add.graphics();
                this.graphics.setDepth(100);
            }


            create ()
            {                
                let start_x = 0;
                let start_y = 0;
                let square_length = this.square_length;
                let margin = this.margin;
                let x = this.x;
                let y = this.y;
                let mod_val = (square_length*x);

                // create interactive image array
                // & click function
                for (let i = 0; i < this.Board.length; i++) {
                    let tent = this.add.image(start_x+margin, start_y+margin, 'square').setOrigin(0,0).setInteractive();
                    
                    tent.setData('index', i);
                    tent.setData('board', this.Board[i]);
                    tent.setData('found', 0);
    
                    this.player_board[i] = tent;
                    start_x = (start_x + square_length) % mod_val;
                    if (start_x == 0){
                        start_y = start_y + square_length;
                    }

                }


                // PLAYER INPUT
                //this.input.on('pointerdown', this.player_input, this);
                this.input.on('pointerdown', function(pointer, currentlyOver) {
                    
                    if (currentlyOver.length == 0) {
                        this.registry.set('lastSquare', -1);

                    } else {
                        let index1 = currentlyOver[0].getData('index')
                        this.registry.set('lastSquare', index1);
                    }
                }, this);



                // TODO can make this more efficient
                this.input.on('pointerup', function(pointer, currentlyOver) {
                    if (currentlyOver.length == 0) {
                        return;
                    }
                    let currSquare = currentlyOver[0].getData('index')
                    let lastSquare = this.registry.get('lastSquare');

                    // case : same square ? 

                    if (lastSquare >= 0){
                        // either the same row
                        if (Math.abs(lastSquare-currSquare) <= 9){
                            // check if the same row

                            if (Math.floor(lastSquare/this.x) == Math.floor(currSquare/this.x)){
                                console.log("SAME ROW");

                                let squares = [];
                                for (let i = Math.min(lastSquare, currSquare); i <= Math.max(lastSquare, currSquare); i++){
                                    squares.push(i);
                                }
                                this.setAllTint(squares, pointer.rightButtonDown());
                            }
                        }
                        // or the same column
                        else if (lastSquare%this.y == currSquare%this.y) {
                            console.log("SAME COL");
                            //console.log(lastSquare, currSquare);

                            let squares = []
                            for (let i = Math.min(lastSquare, currSquare); i <= Math.max(lastSquare, currSquare); i+=this.x){

                                squares.push(i);
                            }

                            this.setAllTint(squares, pointer.rightButtonDown());
                        }
                        else {
                            console.log("NO MATCH");
                        }

                    }

                }, this);






                // add xclues to screen
                // offset from the font size
                let ypos = margin + (square_length/2 - 10);
                let xpos = margin / 3;
                for (let i = 0; i < this.xclues.length; i++) {
                    this.add.text(xpos, ypos, "" + this.xclues[i], {font : '20px Arial'});
                    ypos += square_length;
                }

                // add yclues to screen
                xpos = margin + (square_length/2 - 5);
                for (let i = 0; i < this.yclues.length; i++) {
                    ypos = margin / 3;
                    for (let j = 0; j < this.yclues[i].length; j++){
                        this.add.text(xpos, ypos, "" + this.yclues[i][j], {font: '20px Arial'});
                        ypos+=20;
                    }
                    xpos += square_length;
                }


                draw_guidelines(this);
                

                // restart button
                let newgame_butt = this.add.image(config.width/2, config.height-100, 'newgame').setOrigin(0,0).setInteractive();
                newgame_butt.on('pointerup', this.newGame, this);

                
                // clue helper algo (auto greys out when row/col completes)
                // TODO make optional in settings
                // TODO can make more efficient?

                this.input.on('pointerup', function() {
                    // check rows
                    for (let i = 0; i < this.x; i++) {
                        let all_green = 0;
                        let found_green = 0;
                        for (let j = 0; j < this.y; j++) {
                            if (this.Board[i*this.x + j] == 1) {
                                all_green += 1;
                                if (this.player_board[i*this.x + j].getData('found') == 1){
                                    found_green += 1;
                                }
                            }
                        }
                        // all green in row has been found
                        if (all_green == found_green) {
                            for (let j = 0; j < this.y; j++) {
                                if (this.player_board[i*this.x+j].getData('found') == 0){
                                    this.player_board[i*this.x+j].setTint(0x828282);
                                    this.player_board[i*this.x+j].setData('found', 1);
                                }
                            }
                        }
                    }

                    // check columns
                    for (let j = 0; j < this.y; j++) {
                        let all_green = 0;
                        let found_green = 0;
                        for (let i = 0; i < this.x; i++) {
                            if (this.Board[i*this.x + j] == 1) {
                                all_green += 1;
                                if (this.player_board[i*this.x + j].getData('found') == 1){
                                    found_green += 1;
                                }
                            }
                        }
                        // all green in row has been found
                        if (all_green == found_green) {
                            for (let i = 0; i < this.x; i++) {
                                if (this.player_board[i*this.x+j].getData('found') == 0){
                                    this.player_board[i*this.x+j].setTint(0x828282);
                                    this.player_board[i*this.x+j].setData('found', 1);                                    
                                }
                            }
                        }
                    }

                }, this);  
                
                // info button
                let info_butt = this.add.image(config.width-100,config.height-100, 'infobutton').setOrigin(0,0).setInteractive();
                info_butt.on('pointerdown', function (pointer) {
                    this.scene.pause();
                    this.scene.run('InfoScene');
                }, this);


                /**
                 * End Scene Listener
                 * Counts the number of found green squares.
                 * Ends game scene if found equals total.
                 * Adds green and red count to registry for statistics.
                 * 
                 * @TODO can change to a game object listener instead of pointer?
                 * @TODO can definitely move green_count to be a global variable
                 * @TODO accuracy is wrong now
                 */
                this.input.on('pointerup', function() {

                    // count the number of found green squares & compare
                    let green_count = 0;
                    let red_count = 0;
                    for (let i = 0; i < this.player_board.length; i++) {
                        if (this.player_board[i].getData('board') == 1) {
                            green_count += this.player_board[i].getData('found');
                        } else {
                            red_count += this.player_board[i].getData('found');
                        }
                    }

                    console.log(this.registry.get('board_green'))

                    if (this.registry.get('board_green') == this.board_green) {
                        // add found green and red to registry
                        //this.registry.set('board_green', this.board_green);
                        //this.registry.set('player_red', red_count);
                        
                        // end the game scene
                        this.scene.pause();
                        newgame_butt.setVisible(0);
                        this.scene.run('EndScene');
                    }
                }, this);


            }

            /**
             * Part of listener function, restarts scene.
             */
            newGame()
            {
                console.log('new game');
                this.scene.restart();
                return;
            }

            /**
             * Helper function. Sets all given squares to appropriate color. 
             * Changes 'found' data of appropriate squares
             * @param {array} squares - array of indexes
             * @param {boolean} isGrey - true: set to grey, false: set to red|green
             */
            setAllTint(squares, isGrey)
            {
                for (let i = 0; i < squares.length; i++) {
                    
                    let currSquare = this.player_board[squares[i]];
                    if (currSquare.getData('found') == 0) {
                        if (isGrey) {
                            if (currSquare.isTinted) {
                                currSquare.clearTint();
                            } else {
                                // grey
                                currSquare.setTint(0x828282);
                            }
                        } else {
                            if (currSquare.getData('board') == 1) {
                                // green
                                currSquare.setTint(0x05fa46);
                                this.registry.set('board_green', this.registry.get('board_green')+1);
                            } else {
                                // red
                                currSquare.setTint(0xff0000);
                                this.registry.set('player_red', this.registry.get('player_red')+1);
                            }
                            currSquare.setData('found', 1);
                        }
                    }
                }
                return;
            }

        }








        class EndScene extends Phaser.Scene {
            constructor ()
            {
                super('EndScene');
            }
            preload() 
            {
                this.load.image('endscene', 'assets/endscene_v2.png');                
            }

            create ()
            {
                this.add.image(100, 100, 'endscene').setOrigin(0,0).setAlpha(0.85);

                // new game button
                let newgame_butt = this.add.image(config.width/2, config.height-100, 'newgame').setOrigin(0,0).setInteractive();
                newgame_butt.on('pointerdown', this.newgame, this);
                
                // display accuracy statistic
                let board_green = this.registry.get('board_green');
                let player_red = this.registry.get('player_red');
                this.add.text(200, config.height-75, "Accuracy: " + Math.round(board_green/(player_red+board_green)*10000)/100 + "%");
            }
    
            newgame ()
            {
                console.log('new game');
                this.scene.start("GameScene");
            }
        }







        class InfoScene extends Phaser.Scene {
            constructor ()
            {
                super('InfoScene');
            }
            preload () {
                this.load.image('info', 'assets/infoscene_v2.png');
            }
            create () {
                this.add.image(100, 100, 'info').setOrigin(0,0).setAlpha(0.90);
                this.input.once('pointerdown', this.disappear, this);
            }
            disappear () {
                this.scene.stop();
                this.scene.resume("GameScene");
            }
        }        


        var config = {
            type: Phaser.AUTO,
            width: 1000,
            height: 800,
            parent: 'phaser-example',
            scene: [ GameScene, EndScene, InfoScene]
        };

        var game = new Phaser.Game(config);
                
    </script>


</body>
</html>